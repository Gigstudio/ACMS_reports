## История изменений

### 2025-06-10

- Старт нового проекта **ACMS-Reports**: зафиксировано название, цели, назначение (отчеты по трудовой дисциплине на основе PERCo-Web).
- Определена и согласована концепция событийной системы:
    - Решено разделять серверные и клиентские события (последние — в будущем).
    - Архитектура строится на внешних логгерах с гибкой конфигурацией.
    - Подтверждена необходимость динамической подгрузки описаний событий (title/class) из отдельного конфиг-файла.
    - Принято решение уйти от создания экземпляров Event для каждого события — теперь используется статический интерфейс.
- **Создан интерфейс логгера событий** (`EventLoggerInterface`) в `app/Contracts/EventLoggerInterface.php`:
    - Описывает API для всех видов логгеров событий.
- **Реализован класс FileEventLogger** (`FileEventLogger`) в `app/Core/FileEventLogger.php`:
    - Реализует запись событий в файл (JSON-строка на строку).
    - При необходимости создаёт директорию для логов автоматически.
    - Не содержит жёстко прописанных путей к логам — путь передаётся через конструктор.
- **Переработан Event** (`Event.php`):
    - Полностью статический: события регистрируются через `Event::log()`.
    - Описания событий (title, class) вынесены в конфиг `config/events.php` и подгружаются динамически, с кэшированием.
    - Методы `getTitle` и `getClass` обращаются к конфигу.
    - Статический метод `setLogger()` позволяет задавать внешний логгер событий.
- **Создан файл конфигурации событий** (`config/events.php`):
    - Описания уровней событий: Информация, Сообщение, Предупреждение, Ошибка, Критическая ошибка.
    - Формат: массив `[код события => ['title' => ..., 'class' => ...], ...]`.
- **Реализована регистрация логгера событий**:
    - На раннем этапе запуска приложения (`index.php`) добавлена строка:
      ```php
      Event::setLogger(new FileEventLogger(PATH_LOGS . 'events.log'));
      ```
    - Теперь все события пишутся в лог с самого старта.
- **Обсуждены подходы к live-консоли для разработки/отладки**:
    - Решено, что Event только регистрирует событие, а визуализация будет в отдельном модуле (например, ConsoleController/панель для разработчика).
    - В режиме разработки появится UI для просмотра событий (без polling).
- **Добавлен polyfill** для функций `str_contains` и `str_starts_with` (для поддержки PHP < 8.0).
- **В ErrorHandler** реализовано:
    - Вся логика определения API-запроса теперь внутри ErrorHandler, без зависимости от Request или ContextDetector.
    - Фолбэк-вывод ошибок централизован через `showEarlyErrorPage()`.
    - Введена глобальная константа `APP_READY` (вместо IS_APP_READY) для контроля инициализации приложения.
    - Вызовы MessageController временно закомментированы до внедрения его новой версии.

### 2025-06-11

- **Реализован базовый абстрактный класс Database** (`Database` в `app/Infrastructure/Persistence/Database.php`):
    - Унифицирует общую CRUD-логику, работу с транзакциями, валидацию идентификаторов.
    - Потомки (MySQLClient, FirebirdClient, SQLiteClient) реализуют только специфику.
- **Переработан и расширен DatabaseClientInterface** (`app/Contracts/DatabaseClientInterface.php`):
    - Добавлены методы exec, value, get, first, massInsert, updateOrInsert, begin/commit/rollback, truncate, dropTable, lastInsertId и др.
- **Реализован MySQLClient** (`app/Infrastructure/Persistence/MySQLClient.php`):
    - Полная реализация под интерфейс и базовый класс, используется PDO.
- **GeneralException** полностью интегрирован, оставлен в `GIG\Domain\Exceptions`, поддерживает дополнительные поля и сообщения.
- **Финализирован класс Config** (`GIG\Core\Config`):
    - Полная поддержка вложенных ключей (get/set), перезагрузка, безопасное обращение, кастомные defaults.
    - Весь проект теперь использует единый Config.
- **Переработан ErrorHandler** (`GIG\Core\ErrorHandler`):
    - Полностью синхронизирован с новой архитектурой Event/FileEventLogger.
    - Трассировка (`trace`) автоматически добавляется в payload и отдаётся во фронт только в режиме разработки.
    - Исправлены ошибки с определением типа события, корректно реализована composeMessage.
    - Реализован fallbackRender для ранних ошибок, универсальная dispatch по контексту (API/CLI/UI).
    - Весь стек ошибок логируется через Event::log без создания экземпляров.
- В процессе реализации Application, SchemaManager и всей цепочки инициализации.
- Поддерживается модульность и строгая ООП-структура.

### 2025-06-12

- **Реализован и протестирован мигратор** (`DbSchemaManager`):
    - Корректно создаёт служебные таблицы (`db_settings`, `db_migrations`, `roles`) и основные справочники (`users`, `perco_users`, `divisions`, `positions`, `companies`).
    - Индексы (`PRIMARY`, `MUL`) теперь полностью обрабатываются, ускоряя join и фильтрацию.
    - Роли по умолчанию добавляются автоматически.
- **Восстановлена инициализация ядра приложения**:
    - Последовательность запуска: логгер событий → error handler → мигратор БД → ядро `Application`.
    - Все события и ошибки централизованно фиксируются через Event/Logger.
- **Финализирована архитектура хранения данных**:
    - Минимальные данные пользователя — в таблице `users`.
    - Структура предприятия, полномочия и справочники — в `perco_users`, `divisions`, `positions`, `companies`.
    - Уточнён механизм регистрации аутсорсеров и определение полномочий по badge/identifier.
    - Принято решение: `birthday` и другие "мягкие" данные — только в отдельной таблице `user_profiles`, не в `users`.

- **Реализован и интегрирован класс Request** (`GIG\Core\Request`):
    - Инкапсулирует все параметры HTTP-запроса (метод, путь, роут-параметры, GET/POST/JSON/body, файлы, заголовки).
    - Включает методы проверки типа запроса (`isGet`, `isPost`, `isAjax`, `isApi`), а также статический детектор для API-контекста.
    - Поддерживает работу с “роут-параметрами” для глубокого роутинга.
    - Добавлен механизм получения параметра “из любого источника” (`getParam`).
- **Обновлён класс Response** (`GIG\Core\Response`):
    - Поддержка множественных заголовков (в том числе Set-Cookie).
    - Реализован флаг `isSent` для отслеживания отправки ответа.
    - Добавлен метод `download` для отдачи файлов (с нужными заголовками).
    - Методы `json`, `text`, `html` централизуют работу с типами ответа.
    - Улучшена обработка заголовков (всегда нормализованы, все отправляются).

- **Завершена реализация Router** (`GIG\Core\Router`):
    - Гибкая маршрутизация: поддержка шаблонов с route params, метод `convertPattern` для преобразования `{name}` в именованные группы.
    - Загрузка маршрутов из файла и/или базы (будущее расширение).
    - Обработка ошибок через ErrorHandler, возврат подробных сообщений для 404/405/ошибок маршрутизации.
    - Поддержка передачи query-параметров и route-параметров контроллеру.

- **Реализован и интегрирован AssetManager** (`GIG\Core\AssetManager`):
    - Централизованное хранение и выдача CSS/JS для шаблонов и блоков.
    - Используется на этапе инициализации Application и в ViewHelper.

- **Полностью реализованы и синхронизированы классы Block и Renderer** (`GIG\Core\Block`, `GIG\Core\Renderer`):
    - Поддержка блоковой структуры шаблонов: вложенные блоки, вложенность, добавление стилей и скриптов для каждого блока.
    - Renderer корректно обрабатывает отсутствие шаблона, кидает GeneralException.
    - Безопасное включение файлов, поддержка передачи параметров и children.

- **Реализован ViewHelper** (`GIG\Presentation\View\ViewHelper`):
    - Централизованный доступ к конфигам, ассетам, шрифтам, меню.
    - Используется во всех шаблонах (layout, partials).

- **Реализован FontManager и MenuBuilder** (`GIG\Presentation\View\FontManager`, `MenuBuilder`):
    - Гибкое управление шрифтами, подключение через config.
    - MenuBuilder строит меню с учётом ролей пользователя, поддерживает вложенность, выделяет активные пункты.

- **Уточнён и согласован базовый Controller** (`GIG\Core\Controller`):
    - Добавлен обязательный вывод консоли в render() при debug-режиме.
    - Логика метода json: выбрасывает GeneralException, если вызван вне API-запроса.
    - Обеспечено единообразие интерфейса для всех контроллеров, максимальная изоляция от деталей рендеринга.

- **Проведён аудит и синхронизация изменений Controller/Renderer/Block/ViewHelper**:
    - Все архитектурные требования сохранены: вложенность блоков, ассеты через AssetManager, безопасное извлечение данных.
    - Восстановлена возможность расширения контроллеров, централизованный вызов MessageController для ошибок UI.
    - Контроль ошибок через ErrorHandler, Event::log для всех исключений в рендере.

- **Финализированы и протестированы ErrorHandler, Controller, MessageController, Response**:
    - Контроллеры работают только в "своём" контексте, ошибки передаются вверх как исключения.
    - MessageController восстанавливается как UI-контроллер для ошибок и сообщений, все вызовы через centralized error dispatch.
    - Response централизованно управляет всеми заголовками, исключает повторную отправку, поддерживает все виды ответов.

- **Обновлён README/workflow проекта**:
    - Введено правило: любые нарушения контекста (например, возврат json в UI) — исключение с фиксацией в Event.
    - Все изменения фиксируются в history.md только в формате утверждённых блоков.

### 2025-06-13

- **Завершён цикл базовой визуализации ошибок**:
    - Финализирован и интегрирован `MessageController` для красивого отображения ошибок во фронте.
    - В `ErrorHandler` раскомментирован блок передачи ошибок в UI через `MessageController::error`.
    - Все ошибки, не относящиеся к API/CLI, теперь корректно выводятся с использованием стандартных шаблонов оформления.
    - Проведено тестирование цепочки: ошибка → ErrorHandler → MessageController → render → верстка блока `error`.
- **Уточнена и согласована архитектура передачи ошибок**:
    - Исключён повтор вызова или дублирование обработки исключений между ErrorHandler и контроллерами.
    - Обеспечено единообразие передачи payload ошибок между слоями (контроллер — ErrorHandler — Renderer).
- **Контроллер ошибок теперь работает в общем фреймворке MVC**:
    - Проверено, что все ошибки UI отображаются штатно, включая ошибки ранней загрузки и исключения в контроллерах.

### 2025-06-14

- **Реализована и интегрирована полная структура визуального слоя (View):**
    - Завершено разнесение всех шаблонов по директориям `layouts`, `blocks`, `partials` (ViewHelper, MenuBuilder, FontManager, etc.).
    - Принято новое правило: все блоки лежат в `View/blocks`, разметки — в `View/layouts`, вспомогательные части — в `View/partials`.
    - Подключение CSS/JS организовано централизованно через AssetManager (стили и скрипты собираются и вставляются из конфига).
- **Финализирован базовый Controller и Renderer:**
    - Controller: теперь наследники используют только методы render, json, isApiRequest и setStatus.
    - Renderer: защищён от ошибок шаблонов, все ошибки отдаются через GeneralException.
    - Блоки: реализовано безопасное добавление дочерних блоков, поддержка индивидуальных стилей и скриптов.
    - ViewHelper теперь отдает корректные ссылки на шрифты, стили, скрипты и меню.
- **Восстановлен и доработан MessageController:**
    - Сообщения об ошибках корректно отображаются для UI через контроллер.
    - Все детали ошибки (title, message, detail) корректно прокидываются в error.php и layout.
    - Проведена ревизия передачи данных между ErrorHandler и MessageController.
- **Восстановлен и актуализирован Router:**
    - Router теперь передаёт объект Request в action контроллера, что позволяет унифицировать сигнатуры.
    - Проведён аудит: все контроллеры (UI и API) переведены на работу с объектом Request, в том числе и для передачи routeParams.
    - Исправлена обработка маршрутов с параметрами, реализована строгая фильтрация именованных параметров.
- **Завершена интеграция Console (backend):**
    - Полностью восстановлена рабочая логика класса Console: все методы строго совместимы с прежней (рабочей) реализацией.
    - Логика консоли завязана на сессию PHP (`$_SESSION['console_messages']`), все операции (get, add, clear) корректно работают без "усовершенствований".
    - Все обращения к консоли происходят строго через этот класс, без прямого доступа к сессии в контроллерах.
- **Реализован и согласован ApiAnswer — единый формат ответов API:**
    - Все ответы API строго стандартизированы: поля status, code, message, data (и, опционально, extra).
    - Для статусов принято использовать строковые значения ("success", "error", "missing_param", "denied" и т.д.), допускается расширение через константы или enum.
- **Выполнен рефакторинг базового ApiController:**
    - Все методы API контроллеров теперь возвращают ответ через ApiAnswer, обёрнутый в Response::json.
    - Добавлены вспомогательные методы: requireAuth, requireRole, abort, param, file — реализуют унифицированный доступ к данным и обработку ошибок.
    - Методы success/error/answer теперь работают только с ApiAnswer (никаких ручных массивов).
- **Реализован базовый ConsoleController (API):**
    - Методы: get, add, clear — строго по исходной спецификации (названия методов сохранены).
    - Вызовы json стандартизированы (только через базовый механизм ApiController + ApiAnswer).
    - Исключения и ошибки (например, нехватка данных) выбрасываются через GeneralException, с обработкой на уровне ErrorHandler.
- **Завершена синхронизация backend и frontend по логике работы консоли:**
    - Фронт-энд работает через fetch/await API, использует методы console/get, console/add, console/clear.
    - Все новые сообщения появляются в ленте после действий пользователя без polling/SSE/websocket (строго по механике "action — fetch — обновление UI").
    - Все дублирующие сообщения и ошибки устранены, логика полностью синхронизирована с backend.

### 2025-06-16

#### Переработка архитектуры логирования и событий

- Проведен аудит текущей архитектуры событий, принят курс на выделение сущности Event и менеджера (EventManager).
- Реализован абстрактный базовый класс Entity для унификации сущностей в Domain-слое.
- Переведены все события на новый формат: Event как ValueObject, EventManager как центральная точка логирования.

#### Миграция хранения событий: сессия → БД → файл

- Принято решение: события (логи) — сохраняются в БД, пишутся в файл (читаемый лог), попадают в сессию для отображения в консоли.
- Разработана структура таблицы log в MySQL (`id`, `type`, `source`, `message`, `timestamp`, `data`, `user_id`, `ip`).
- Реализован EventRepository для работы с таблицей log через MySQLClient.
- FileEventLogger форматирует логи для файла (журнал событий в текстовом виде).
- Проведен рефакторинг методов сохранения: теперь все идет через EventManager.

#### Рефакторинг и стандартизация слоя Console

- Переработан класс Console: все сообщения теперь завязаны на сущность Event (`toArray()`), фильтрация, лимит, очистка, lastMessage, count.
- Утверждена цепочка: ErrorHandler/любой сервис → EventManager → EventRepository/FileLogger/Console.
- Описан формат хранения сообщений в сессии и лог-файле.
- Удалены старые методы, несогласованные с новой структурой.

#### Имплементация REST API для консоли

- Определена новая карта маршрутов для API (`config/apimap.php`): GET/POST/DELETE для `/api/console`.
- Реализован ConsoleController с поддержкой REST-эндпоинтов: get, add, clear, count, last.
- Обеспечено соответствие APIAnswer формату успешных/ошибочных ответов.

#### Согласование работы роутера и структуры маршрутов

- Приведена структура роутера к поддержке раздельных файлов маршрутов: `config/routes.php` (UI) и `config/apimap.php` (API).
- Реализована загрузка и переключение между api/ui в зависимости от `Request::isApi()`.
- Внедрен отладочный логгер маршрутов (`router.log`) для контроля совпадения uri/pattern.

#### Адаптация фронта (AppConsole, APIClient, main.js)

- Старая версия фронта сохранена как эталон для рефакторинга — переход на REST-структуру, но совместимость с историей сообщений.
- AppConsole адаптирован к новым эндпоинтам (GET/POST/DELETE на `/api/console`), сохранены методы update, clear, add, count, last.
- Все фильтры и взаимодействие с localStorage вынесены в отдельные методы.
- Минимальные доработки для корректной работы с текущей логикой backend.

#### Исправления ошибок и повышение устойчивости

- Исправлена критическая ошибка с неинициализированным свойством `Request::$bodyParams` (инициализация по умолчанию).
- Проведен аудит типов, обработка возможных неинициализированных значений (PHP 8+).
- Актуализированы неймспейсы, синхронизировано соглашение по имени (`Api/` vs `API/` и т.д.).

#### Дополнительно

- Реализована централизованная инициализация `EventManager`, `ErrorHandler` и `Application` (правильный порядок создания сервисов и логгеров).
- Проведена ревизия событий — теперь `source` всегда содержит короткое имя класса, а не путь к файлу.
- Зафиксировано: все критические изменения обсуждаются с анализом, согласованы правила ведения истории и внесения изменений.

### 2025-06-17

#### Исправления и доработки ErrorHandler

- Переписан механизм вывода ошибок: добавлена обработка ситуаций, когда заголовки уже отправлены или содержимое страницы уже начало формироваться (`headers_sent` и `ob_get_level`).
- Исправлена ситуация, когда предупреждения и ошибки (`E_WARNING`, `E_USER_WARNING`) «выпуливались» в основной контент страницы — теперь UI не портится при ошибках, возникших в процессе рендеринга.
- Внесены правки в `dispatch`: теперь блокируется вызов `MessageController::error`, если ошибка возникла во время формирования страницы, чтобы не возникало «контента в контенте».
- Добавлен более корректный порядок инициализации `ErrorHandler` (регистрируется ДО запуска приложения).
- Улучшена диагностика ошибок — сообщения теперь логируются с коротким классом источника (а не с полным путем к файлу), чтобы упростить просмотр событий в консоли.
- Проверена корректность работы `error_reporting` и php.ini (`display_errors`, `log_errors`), устранены лишние выводы в UI.
- Введена дополнительная защита от вывода дубликатов ошибок при ajax-запросах.

### 2025-06-20
- Сформулировано архитектурное резюме и требования к стилю работы для новой сессии.
- Актуализированы все принципы DDD, централизованной обработки ошибок, логирования, слоёв взаимодействия.
- Зафиксированы требования к фронтенду (statusbar, event-driven взаимодействие).
- Обозначен перечень открытых задач на текущий момент.

...